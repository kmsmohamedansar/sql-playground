<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mohamedâ€™s SQL Playground â€” Snowflake Style</title>
  <meta name="description" content="Practice Snowflake-flavored SQL in your browser. SQLite (sql.js) with a translation layer: DESCRIBE, SHOW, ILIKE, DATE_TRUNC, and more." />
  <meta name="theme-color" content="#0f172a" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: { boxShadow: { glow: '0 0 40px rgba(99,102,241,.35)' } }
      }
    }
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- SQL.js (SQLite in WASM) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
  <!-- Papa Parse (CSV import) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    textarea, code, pre, kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    html { color-scheme: light; } html.dark { color-scheme: dark; }
  </style>

  <!-- Initial theme (avoid FOUC) -->
  <script>
    (function() {
      try {
        const ls = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const wantDark = ls ? (ls === 'dark') : prefersDark;
        document.documentElement.classList.toggle('dark', wantDark);
      } catch(_) {}
    })();
  </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex flex-col">
  <!-- Navbar -->
  <nav class="sticky top-0 z-50 bg-white/80 dark:bg-gray-800/70 backdrop-blur shadow">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ðŸ§ </span>
        <a href="#" class="font-extrabold text-xl md:text-2xl">Mohamedâ€™s SQL Playground</a>
        <span class="hidden md:inline text-sm text-gray-500 dark:text-gray-400 ml-2">Snowflake-style commands</span>
      </div>
      <div class="flex items-center gap-2">
        <span id="context-chip" class="px-2 py-1 text-xs rounded bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-200">DB: MAIN â€¢ SCHEMA: PUBLIC</span>
        <button id="theme-toggle" class="px-3 py-1.5 text-sm rounded-lg bg-gray-200 dark:bg-gray-700">ðŸŒ— Theme</button>
        <a href="https://github.com/kmsmohamedansar/sql-playground" target="_blank" class="px-3 py-1.5 text-sm rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">GitHub</a>
      </div>
    </div>
  </nav>

  <!-- Layout -->
  <main class="max-w-7xl mx-auto w-full px-4 py-5 grid gap-5 lg:grid-cols-[280px_minmax(0,1fr)]">
    <!-- Sidebar -->
    <aside class="bg-white dark:bg-gray-800 rounded-xl shadow p-4 h-fit">
      <h2 class="font-semibold text-lg mb-2">ðŸ“š Schema</h2>
      <div id="schema" class="space-y-3 text-sm"></div>

      <hr class="my-4 border-gray-200 dark:border-gray-700">

      <h2 class="font-semibold text-lg mb-2">ðŸ§© Samples</h2>
      <div class="space-y-2 text-sm">
        <button class="w-full text-left px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600" data-example="sf-describe">DESCRIBE TABLE employees;</button>
        <button class="w-full text-left px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600" data-example="sf-show-tables">SHOW TABLES;</button>
        <button class="w-full text-left px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600" data-example="sf-ilike">SELECT * FROM customers WHERE name ILIKE '%co%';</button>
        <button class="w-full text-left px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600" data-example="sf-date-trunc">SELECT DATE_TRUNC('month', order_date) AS month, ROUND(SUM(amount),2) AS revenue FROM orders GROUP BY 1 ORDER BY 1;</button>
        <button class="w-full text-left px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600" data-example="join-top">-- Top earners per dept (window)\nWITH r AS (\n  SELECT e.*, d.name AS dept,\n         DENSE_RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) AS rnk\n  FROM employees e JOIN departments d ON e.department_id = d.id\n)\nSELECT id,name,dept,salary FROM r WHERE rnk=1 ORDER BY dept,name;</button>
      </div>

      <hr class="my-4 border-gray-200 dark:border-gray-700">

      <h2 class="font-semibold text-lg mb-2">ðŸ’¾ Saved Queries</h2>
      <div id="saved-list" class="space-y-2 text-sm"></div>
      <div class="mt-2 flex gap-2">
        <button id="save-query" class="flex-1 px-3 py-2 rounded bg-emerald-600 text-white hover:bg-emerald-700">Save</button>
        <button id="clear-saved" class="px-3 py-2 rounded bg-gray-200 dark:bg-gray-700">Clear</button>
      </div>

      <hr class="my-4 border-gray-200 dark:border-gray-700">

      <h2 class="font-semibold text-lg mb-2">ðŸ“¥ Import CSV</h2>
      <label class="block text-xs mb-1">Create table from CSV</label>
      <input id="csv-file" type="file" accept=".csv" class="block w-full text-xs mb-2">
      <input id="csv-table-name" type="text" placeholder="table_name"
             class="w-full text-xs px-2 py-1 rounded bg-gray-50 dark:bg-gray-900 border dark:border-gray-700 mb-2">
      <button id="import-csv" class="w-full px-3 py-2 rounded bg-sky-600 text-white hover:bg-sky-700 text-sm">Import</button>

      <hr class="my-4 border-gray-200 dark:border-gray-700">

      <button id="reset-db" class="w-full px-3 py-2 rounded bg-rose-600 text-white hover:bg-rose-700 text-sm">Reset Database</button>
    </aside>

    <!-- Main Work Area -->
    <section class="space-y-5">
      <!-- Editor Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
        <div class="flex items-center justify-between flex-wrap gap-2 mb-2">
          <h2 class="font-semibold text-lg">ðŸ§ª Query Editor (Snowflake style accepted)</h2>
          <div class="text-xs text-gray-500 dark:text-gray-400">Tip: <kbd class="px-1.5 py-0.5 bg-gray-200 dark:bg-gray-700 rounded">Ctrl/Cmd + Enter</kbd> to run</div>
        </div>
        <textarea id="sql-input" rows="8"
          class="w-full p-3 rounded border bg-gray-50 dark:bg-gray-900 dark:border-gray-700"
        >-- Try Snowflake style:
DESCRIBE TABLE employees;
SHOW TABLES;
SELECT * FROM customers WHERE name ILIKE '%co%';
SELECT DATE_TRUNC('month', order_date) AS month, SUM(amount) FROM orders GROUP BY 1;</textarea>

        <div class="mt-3 flex items-center gap-2 flex-wrap">
          <button id="run" class="px-4 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700 shadow">â–¶ Run (Ctrl/Cmd+Enter)</button>
          <button id="format" class="px-3 py-2 rounded bg-gray-200 dark:bg-gray-700">Format</button>
          <button id="clear" class="px-3 py-2 rounded bg-gray-200 dark:bg-gray-700">Clear</button>
          <span id="status" class="ml-auto text-sm text-gray-500 dark:text-gray-400">Ready</span>
        </div>
      </div>

      <!-- Results Card -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-2">
          <h2 class="font-semibold text-lg">ðŸ“Š Results</h2>
          <div class="flex items-center gap-2">
            <button id="copy-csv" class="px-3 py-1.5 text-sm rounded bg-gray-200 dark:bg-gray-700">Copy CSV</button>
            <button id="download-csv" class="px-3 py-1.5 text-sm rounded bg-gray-200 dark:bg-gray-700">Download CSV</button>
          </div>
        </div>
        <div id="result-meta" class="text-xs text-gray-500 dark:text-gray-400 mb-2">0 rows â€¢ 0 ms</div>
        <div id="results" class="overflow-x-auto text-sm"></div>
      </div>

      <!-- Practice Tasks -->
      <div class="bg-white dark:bg-gray-800 rounded-xl shadow p-4">
        <h2 class="font-semibold text-lg mb-2">ðŸ§  Practice Tasks (Data Engineering)</h2>
        <ul class="list-disc pl-6 text-sm space-y-1 text-gray-700 dark:text-gray-300">
          <li>Return employee name, department name, and salary (JOIN employees â†” departments).</li>
          <li>For each department, show the top earner (window function: RANK/DENSE_RANK).</li>
          <li>Monthly revenue from <code>orders</code> (DATE_TRUNC) sorted descending.</li>
          <li>Customer lifetime value: total amount and first order date per customer.</li>
          <li>Projects with no assigned employees (LEFT JOIN anti-join).</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="text-center py-6 text-gray-500 dark:text-gray-400 text-sm">
    Built by Mohamed â€¢ Snowflake-style on SQLite â€¢ <a href="https://github.com/kmsmohamedansar/sql-playground" target="_blank" class="underline">Source</a>
  </footer>

  <script>
    // THEME
    (function(){
      const btn = document.getElementById('theme-toggle');
      const root = document.documentElement;
      function setTheme(t){ root.classList.toggle('dark', t === 'dark'); try{ localStorage.setItem('theme', t); }catch(_){} }
      btn?.addEventListener('click', ()=> setTheme(root.classList.contains('dark') ? 'light' : 'dark'));
    })();

    // GLOBALS
    let db;                 // SQL.js Database instance
    let lastRows = [];      // Last result rows for CSV copy/download
    let lastColumns = [];   // Last result columns
    let currentDB = 'MAIN';
    let currentSchema = 'PUBLIC';

    // Update header chip
    function refreshContextChip(){
      const chip = document.getElementById('context-chip');
      chip.textContent = `DB: ${currentDB} â€¢ SCHEMA: ${currentSchema}`;
    }

    // LIGHT SQL FORMATTER
    function formatSQL(sql){
      return sql
        .replace(/\s+/g,' ')
        .replace(/\b(select|from|where|group by|order by|left join|join|inner join|outer join|with|on|limit|offset|having|qualify)\b/gi, s => s.toUpperCase())
        .replace(/,\s*/g, ', ')
        .replace(/\s*;\s*$/, ';')
        .trim();
    }

    // CSV UTILS
    function toCSV(columns, rows){
      const esc = v => {
        if (v === null || v === undefined) return '';
        const s = String(v);
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
      };
      return [columns.join(','), ...rows.map(r => r.map(esc).join(','))].join('\n');
    }

    // RENDER TABLE
    function renderTable(container, columns, rows){
      const tbl = document.createElement('table');
      tbl.className = 'table-auto border-collapse border border-gray-300 dark:border-gray-700 w-full';
      const thead = document.createElement('thead');
      thead.innerHTML = '<tr>' + columns.map(c => `<th class="border px-2 py-1 bg-gray-100 dark:bg-gray-700 text-left">${c}</th>`).join('') + '</tr>';
      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        r.forEach(v => {
          const td = document.createElement('td'); td.className = 'border px-2 py-1'; td.textContent = v; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      tbl.appendChild(thead); tbl.appendChild(tbody);
      container.innerHTML = ''; container.appendChild(tbl);
    }

    // SCHEMA EXPLORER
    function updateSchema(){
      const schemaEl = document.getElementById('schema');
      if (!db) return;
      const tables = db.exec(`SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name;`);
      schemaEl.innerHTML = '';
      if (!tables.length) { schemaEl.textContent = 'No tables'; return; }

      tables[0].values.forEach(([tname]) => {
        const cols = db.exec(`PRAGMA table_info(${tname});`)[0]?.values || [];
        const count = db.exec(`SELECT COUNT(*) AS n FROM ${tname};`)[0]?.values?.[0]?.[0] ?? 0;
        const wrap = document.createElement('div');
        wrap.className = 'border border-gray-200 dark:border-gray-700 rounded-lg';
        const header = document.createElement('div');
        header.className = 'px-3 py-2 bg-gray-50 dark:bg-gray-900 flex items-center justify-between cursor-pointer rounded-t-lg';
        header.innerHTML = `<div class="font-medium">${tname}</div><div class="text-xs text-gray-500">${count} rows</div>`;
        const body = document.createElement('div');
        body.className = 'px-3 py-2 hidden';
        body.innerHTML = '<ul class="text-xs text-gray-600 dark:text-gray-300 space-y-1">' +
          cols.map(c => `<li><code>${c[1]}</code> <span class="text-gray-400">(${c[2]})</span></li>`).join('') +
          '</ul>' +
          `<div class="mt-2 flex gap-2">
             <button class="px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700" data-preview="${tname}">Preview</button>
             <button class="px-2 py-1 text-xs rounded bg-gray-200 dark:bg-gray-700" data-insert="${tname}">Insert SELECT</button>
           </div>`;
        header.addEventListener('click', ()=> body.classList.toggle('hidden'));
        wrap.appendChild(header); wrap.appendChild(body); schemaEl.appendChild(wrap);
      });

      schemaEl.querySelectorAll('[data-preview]').forEach(btn=>{
        btn.addEventListener('click', ()=> { setSQL(`SELECT * FROM ${btn.getAttribute('data-preview')} LIMIT 20;`); runSQL(); });
      });
      schemaEl.querySelectorAll('[data-insert]').forEach(btn=>{
        btn.addEventListener('click', ()=> insertSQL(`\nSELECT * FROM ${btn.getAttribute('data-insert')} LIMIT 20;`));
      });
    }

    // EDITOR HELPERS
    function getSQL(){ return document.getElementById('sql-input').value; }
    function setSQL(v){ document.getElementById('sql-input').value = v; }
    function insertSQL(s){ const el = document.getElementById('sql-input'); el.value += s; el.focus(); }

    // --- SNOWFLAKE TRANSLATION LAYER ---
    // Returns { sql, synthetic }:
    //  - sql: rewritten SQLite-compatible SQL (or null if synthetic only)
    //  - synthetic: { columns:[], rows:[] } for SHOW-like commands we fake
    function translateSnowflake(input){
      let sql = input.trim().replace(/;+\s*$/,''); // strip trailing semicolons only for parsing
      const upper = sql.toUpperCase();

      // USE DATABASE/SCHEMA
      let m = upper.match(/^USE\s+DATABASE\s+([A-Z0-9_"]+)$/i);
      if (m){
        currentDB = stripQuotes(m[1]).toUpperCase();
        refreshContextChip();
        return { synthetic: { columns: ['status'], rows: [[`Database changed to ${currentDB}`]] }, sql: null };
      }
      m = upper.match(/^USE\s+SCHEMA\s+([A-Z0-9_".]+)$/i);
      if (m){
        currentSchema = stripQuotes(m[1].split('.').pop()).toUpperCase();
        refreshContextChip();
        return { synthetic: { columns: ['status'], rows: [[`Schema changed to ${currentSchema}`]] }, sql: null };
      }

      // DESCRIBE / DESC TABLE|VIEW <name>
      m = upper.match(/^DESCRIBE\s+(TABLE|VIEW)\s+(.+)$/i) || upper.match(/^DESC\s+(TABLE|VIEW)\s+(.+)$/i);
      if (m){
        const name = stripQuotes(sql.split(/\s+/).slice(2).join(' ').replace(/^(TABLE|VIEW)\s+/i,'')).split(/\s+/)[0];
        return { sql: `PRAGMA table_info(${name});` };
      }

      // SHOW TABLES [LIKE 'pattern']
      m = upper.match(/^SHOW\s+TABLES(\s+LIKE\s+('.+'|".+"))?$/i);
      if (m){
        const like = m[1] ? sql.match(/LIKE\s+('.+'|".+")/i)[1] : null;
        const pattern = like ? like.replace(/(^['"]|['"]$)/g,'') : '%';
        return {
          sql: `
            SELECT name AS "name"
            FROM sqlite_master
            WHERE type='table' AND name NOT LIKE 'sqlite_%' AND name LIKE ${q(pattern)}
            ORDER BY name
          `
        };
      }

      // SHOW VIEWS
      if (/^SHOW\s+VIEWS\s*$/i.test(upper)){
        return { sql: `SELECT name AS "name" FROM sqlite_master WHERE type='view' ORDER BY name;` };
      }

      // SHOW SCHEMAS / DATABASES (simulate)
      if (/^SHOW\s+SCHEMAS\s*$/i.test(upper)){
        return { synthetic: { columns:['name'], rows: [[currentSchema]] }, sql: null };
      }
      if (/^SHOW\s+DATABASES\s*$/i.test(upper)){
        return { synthetic: { columns:['name'], rows: [[currentDB]] }, sql: null };
      }

      // SHOW COLUMNS [IN|FROM] <table>
      m = upper.match(/^SHOW\s+COLUMNS\s+(IN|FROM)\s+(.+)$/i);
      if (m){
        const t = stripQuotes(sql.replace(/^SHOW\s+COLUMNS\s+(IN|FROM)\s+/i,'').trim());
        return { sql: `PRAGMA table_info(${t});` };
      }

      // ILIKE -> case-insensitive LIKE
      // Replace: <expr> ILIKE <pattern>  -> LOWER(<expr>) LIKE LOWER(<pattern>)
      sql = sql.replace(/(\S+)\s+ILIKE\s+('(?:[^']|\\')*'|"(?:[^"]|\\" )*")/gi,
        (_, lhs, rhs) => `LOWER(${lhs}) LIKE LOWER(${rhs})`);

      // DATE_TRUNC('month', col) -> strftime('%Y-%m-01', col)
      // DATE_TRUNC('day', col)   -> date(col)
      sql = sql.replace(/DATE_TRUNC\(\s*'(\w+)'\s*,\s*([^)]+)\)/gi, (_, unit, expr) => {
        unit = unit.toLowerCase();
        expr = expr.trim();
        if (unit === 'month') return `strftime('%Y-%m-01', ${expr})`;
        if (unit === 'year')  return `strftime('%Y-01-01', ${expr})`;
        if (unit === 'day')   return `date(${expr})`;
        return `date(${expr})`; // fallback
      });

      // QUALIFY <cond>  -> wrap as outer WHERE when the inner uses row_number()/rank()/dense_rank()
      // Simple rewrite: SELECT ... FROM (...) t QUALIFY rnk=1  -> SELECT * FROM (SELECT ..., DENSE_RANK()... as rnk FROM ...) WHERE rnk=1
      // We only handle trivial cases:
      if (/QUALIFY\s+/i.test(sql)){
        const parts = sql.split(/QUALIFY/i);
        const left = parts[0].trim().replace(/;$/,'');
        const qual = parts[1].trim();
        sql = `SELECT * FROM (${left}) WHERE ${qual}`;
      }

      // End with semicolon for SQL.js friendliness
      return { sql: sql + ';' };
    }

    function stripQuotes(s){ return s.replace(/^["'`]|["'`]$/g,''); }
    function q(s){ return `'${String(s).replace(/'/g,"''")}'`; }

    // RUN QUERY
    function runSQL(){
      const status = document.getElementById('status');
      const resultMeta = document.getElementById('result-meta');
      const resultsEl = document.getElementById('results');
      const raw = getSQL();
      if (!raw.trim()) return;

      try {
        const t0 = performance.now();
        const { sql, synthetic } = translateSnowflake(raw);

        resultsEl.innerHTML = '';
        let totalRows = 0;
        lastRows = []; lastColumns = [];

        if (synthetic){
          renderTable(resultsEl, synthetic.columns, synthetic.rows);
          totalRows = synthetic.rows.length;
        } else if (sql){
          const res = db.exec(sql);
          if (res.length === 0){
            resultsEl.innerHTML = `<p class="text-gray-500">No results.</p>`;
          } else {
            res.forEach((table, i) => {
              const section = document.createElement('div');
              if (res.length > 1){
                section.innerHTML = `<div class="mb-1 text-xs text-gray-500">Result set ${i+1}</div>`;
              }
              renderTable(section, table.columns, table.values);
              resultsEl.appendChild(section);
              totalRows += table.values.length;
              lastColumns = table.columns; lastRows = table.values;
            });
          }
        }

        const t1 = performance.now();
        resultMeta.textContent = `${totalRows} row${totalRows===1?'':'s'} â€¢ ${Math.round(t1 - t0)} ms`;
        status.textContent = 'Success';
        status.className = 'ml-auto text-sm text-emerald-600';
      } catch (err) {
        resultsEl.innerHTML = `<p class="text-rose-600">Error: ${err.message}</p>`;
        document.getElementById('result-meta').textContent = 'â€”';
        status.textContent = 'Error';
        status.className = 'ml-auto text-sm text-rose-600';
      }
    }

    // SAVE QUERIES (localStorage)
    function loadSaved(){
      const saved = JSON.parse(localStorage.getItem('saved_queries') || '[]');
      const list = document.getElementById('saved-list');
      list.innerHTML = '';
      if (!saved.length){
        list.innerHTML = '<div class="text-xs text-gray-500">No saved queries.</div>';
        return;
      }
      saved.forEach((item, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2';
        row.innerHTML = `
          <button class="flex-1 text-left px-3 py-2 rounded bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600">${item.name}</button>
          <button class="px-2 py-1 text-xs rounded bg-rose-600 text-white" data-del="${idx}">Del</button>
        `;
        row.querySelector('button').addEventListener('click', ()=> setSQL(item.sql));
        row.querySelector('[data-del]').addEventListener('click', ()=>{
          const arr = JSON.parse(localStorage.getItem('saved_queries') || '[]');
          arr.splice(idx,1);
          localStorage.setItem('saved_queries', JSON.stringify(arr));
          loadSaved();
        });
        list.appendChild(row);
      });
    }

    // CSV COPY / DOWNLOAD
    function copyCSV(){
      if (!lastRows.length){ alert('No results to copy.'); return; }
      const csv = toCSV(lastColumns, lastRows);
      navigator.clipboard.writeText(csv).then(()=> {
        const old = document.getElementById('status').textContent;
        document.getElementById('status').textContent = 'CSV copied';
        setTimeout(()=> document.getElementById('status').textContent = old, 1200);
      });
    }
    function downloadCSV(){
      if (!lastRows.length){ alert('No results to download.'); return; }
      const csv = toCSV(lastColumns, lastRows);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'results.csv';
      document.body.appendChild(a); a.click();
      setTimeout(()=> { URL.revokeObjectURL(url); a.remove(); }, 0);
    }

    // DB SEED
    async function seedDB(SQL){
      db = new SQL.Database();

      // Employees / Departments / Projects
      db.run(`
        CREATE TABLE departments (id INTEGER PRIMARY KEY, name TEXT);
        INSERT INTO departments (id, name) VALUES
          (10, 'Engineering'), (20, 'Marketing'), (30, 'Finance'), (40, 'Operations');

        CREATE TABLE employees (
          id INTEGER PRIMARY KEY,
          name TEXT,
          department_id INTEGER,
          salary REAL,
          hired_at TEXT,
          FOREIGN KEY(department_id) REFERENCES departments(id)
        );
        INSERT INTO employees (id, name, department_id, salary, hired_at) VALUES
          (1,'Alice',10,  95000,'2022-04-10'),
          (2,'Bob',20,    65000,'2023-02-01'),
          (3,'Charlie',30,72000,'2021-11-05'),
          (4,'Diana',10, 110000,'2020-08-22'),
          (5,'Ethan',40,  80000,'2024-06-12'),
          (6,'Farah',10,  99000,'2023-09-01');

        CREATE TABLE projects (
          id INTEGER PRIMARY KEY,
          name TEXT,
          department_id INTEGER,
          start_date TEXT
        );
        INSERT INTO projects (id, name, department_id, start_date) VALUES
          (101,'Data Platform Revamp',10,'2024-01-05'),
          (102,'Brand Campaign',20,'2024-03-12'),
          (103,'Cost Audit',30,'2023-10-01');

        CREATE TABLE project_assignments (project_id INTEGER, employee_id INTEGER);
        INSERT INTO project_assignments VALUES
          (101,1),(101,4),(101,6),
          (102,2),
          (103,3);
      `);

      // Customers / Orders (sales-style)
      db.run(`
        CREATE TABLE customers (id INTEGER PRIMARY KEY, name TEXT, city TEXT);
        INSERT INTO customers (id, name, city) VALUES
          (201,'Nova Foods','Toronto'),
          (202,'Zen Merch','Vancouver'),
          (203,'Acme Retail','Montreal'),
          (204,'Polar Co','Calgary');

        CREATE TABLE orders (id INTEGER PRIMARY KEY, customer_id INTEGER, order_date TEXT, amount REAL);
        INSERT INTO orders (id, customer_id, order_date, amount) VALUES
          (1001,201,'2024-05-02',1200.50),
          (1002,202,'2024-05-13', 980.00),
          (1003,201,'2024-06-07', 640.25),
          (1004,203,'2024-06-11', 320.00),
          (1005,201,'2024-07-03', 450.75),
          (1006,204,'2024-07-21', 999.99),
          (1007,203,'2024-07-28', 250.00),
          (1008,204,'2024-08-04', 500.00);
      `);
    }

    // RESET DB
    async function resetDB(){
      const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` });
      await seedDB(SQL);
      updateSchema();
      setSQL(`-- DB reset. Try Snowflake-style commands.\nDESCRIBE TABLE employees;\nSHOW TABLES;`);
      document.getElementById('results').innerHTML = '';
      document.getElementById('result-meta').textContent = 'â€”';
      document.getElementById('status').textContent = 'Ready';
      document.getElementById('status').className = 'ml-auto text-sm text-gray-500 dark:text-gray-400';
      refreshContextChip();
    }

    // INIT
    (async function init(){
      await resetDB();

      // Buttons
      document.getElementById('run').addEventListener('click', runSQL);
      document.getElementById('format').addEventListener('click', ()=> setSQL(formatSQL(getSQL())));
      document.getElementById('clear').addEventListener('click', ()=> setSQL(''));
      document.getElementById('copy-csv').addEventListener('click', copyCSV);
      document.getElementById('download-csv').addEventListener('click', downloadCSV);
      document.getElementById('reset-db').addEventListener('click', resetDB);

      // Keyboard shortcut
      document.addEventListener('keydown', (e)=>{
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter'){ e.preventDefault(); runSQL(); }
      });

      // Examples
      const EXAMPLES = {
        'sf-describe': 'DESCRIBE TABLE employees;',
        'sf-show-tables': 'SHOW TABLES;',
        'sf-ilike': "SELECT * FROM customers WHERE name ILIKE '%co%';",
        'sf-date-trunc': "SELECT DATE_TRUNC('month', order_date) AS month, ROUND(SUM(amount),2) AS revenue FROM orders GROUP BY 1 ORDER BY 1;",
        'join-top': `WITH r AS (
  SELECT e.*, d.name AS dept,
         DENSE_RANK() OVER (PARTITION BY department_id ORDER BY salary DESC) AS rnk
  FROM employees e JOIN departments d ON e.department_id = d.id
)
SELECT id,name,dept,salary FROM r WHERE rnk=1 ORDER BY dept,name;`
      };
      document.querySelectorAll('[data-example]').forEach(btn=>{
        btn.addEventListener('click', ()=> setSQL(EXAMPLES[btn.getAttribute('data-example')] || ''));
      });

      // Saved queries
      loadSaved();
      document.getElementById('save-query').addEventListener('click', ()=>{
        const name = prompt('Save query as (name):');
        if (!name) return;
        const sql = getSQL();
        const arr = JSON.parse(localStorage.getItem('saved_queries') || '[]');
        arr.push({ name, sql });
        localStorage.setItem('saved_queries', JSON.stringify(arr));
        loadSaved();
      });
      document.getElementById('clear-saved').addEventListener('click', ()=>{
        if (confirm('Clear all saved queries?')) { localStorage.removeItem('saved_queries'); loadSaved(); }
      });

      // CSV import
      document.getElementById('import-csv').addEventListener('click', ()=>{
        const f = document.getElementById('csv-file').files[0];
        const t = document.getElementById('csv-table-name').value.trim();
        if (!f || !t){ alert('Pick a CSV file and table name.'); return; }
        Papa.parse(f, {
          header: true, skipEmptyLines: true,
          complete: (results)=>{
            const rows = results.data;
            if (!rows.length){ alert('Empty CSV'); return; }
            const columns = Object.keys(rows[0]);
            const safeName = t.replace(/[^a-zA-Z0-9_]/g,'_');
            const colDefs = columns.map(c => `${c.replace(/[^a-zA-Z0-9_]/g,'_')} TEXT`).join(', ');
            db.run(`CREATE TABLE ${safeName} (${colDefs});`);
            const placeholders = columns.map(_=> '?').join(',');
            const stmt = db.prepare(`INSERT INTO ${safeName} VALUES (${placeholders})`);
            rows.forEach(r => stmt.run(columns.map(c => r[c])));
            stmt.free();
            updateSchema();
            setSQL(`SELECT * FROM ${safeName} LIMIT 20;`);
            runSQL();
          }
        });
      });
    })();
  </script>
</body>
</html>
